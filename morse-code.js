const MORSE_CODE = {
    'ja': { // 和文モールス符号
        'ア': '－－・－－', 'イ': '・－', 'ウ': '・・－', 'エ': '－・－－－', 'オ': '・－・・・',
        'カ': '・－・・', 'キ': '－・－・・', 'ク': '・・・－', 'ケ': '－・－－', 'コ': '－－－－',
        'サ': '－・－・－', 'シ': '－－・－・', 'ス': '－－－・－', 'セ': '・－－－・', 'ソ': '－－－・',
        'タ': '－・', 'チ': '・・－・', 'ツ': '・－－・', 'テ': '・－・－－', 'ト': '・・－・・',
        'ナ': '・－・', 'ニ': '－・－・', 'ヌ': '・・・・', 'ネ': '－－・－', 'ノ': '・・－－',
        'ハ': '－・・・', 'ヒ': '－－・・－', 'フ': '－－・・', 'ヘ': '・', 'ホ': '－・・',
        'マ': '－・・－', 'ミ': '・・－・－', 'ム': '－', 'メ': '－・・・－', 'モ': '－・・－－',
        'ヤ': '・－－', 'ユ': '－・・－－', 'ヨ': '－－',
        'ラ': '・・・', 'リ': '－－・', 'ル': '－・－－・', 'レ': '－－－', 'ロ': '・－・－',
        'ワ': '－・－', 'ヰ': '・－・・－', 'ヱ': '・－－・・', 'ヲ': '・－－－', 'ン': '・－・－・',
        '゛': '・・', '゜': '・・－－・',
        'ー': '・－－・－', '、': '・－・－・－', '」': '・－・－・・',
        '1': '・－－－－', '2': '・・－－－', '3': '・・・－－', '4': '・・・・－', '5': '・・・・・',
        '6': '－・・・・', '7': '－－・・・', '8': '－－－・・', '9': '－－－－・', '0': '－－－－－',
    },
    'en': { // 英文モールス符号
        'A': '・－', 'B': '－・・・', 'C': '－・－・', 'D': '－・・', 'E': '・', 'F': '・・－・',
        'G': '－－・', 'H': '・・・・', 'I': '・・', 'J': '・－－－', 'K': '－・－', 'L': '・－・・',
        'M': '－－', 'N': '－・', 'O': '－－－', 'P': '・－－・', 'Q': '－－・－', 'R': '・－・',
        'S': '・・・', 'T': '－', 'U': '・・－', 'V': '・・・－', 'W': '・－－', 'X': '－・・－',
        'Y': '－・－－', 'Z': '－－・・',
        '1': '・－－－－', '2': '・・－－－', '3': '・・・－－', '4': '・・・・－', '5': '・・・・・',
        '6': '－・・・・', '7': '－－・・・', '8': '－－－・・', '9': '－－－－・', '0': '－－－－－',
        '.': '・－・－・－', ',': '－－・・－－', '?': '・・－－・・', "'": '・－－－－・',
        '!': '－・－・－－', '/': '－・・－・', '(': '－・－－・', ')': '－・－－・－',
        '&': '・－・・・', ':': '－－－・・・', ';': '－・－・－・', '=': '－・・・－',
        '+': '・－・－・', '-': '－・・・・－', '_': '・・－－・－', '"': '・－・・－・',
        '$': '・・・－・・－', '@': '・－－・－・'
    }
};

// スペイン語のモールス信号を追加
MORSE_CODE.es = {
    ...MORSE_CODE.en,
    'Ñ': '－－・－－'
};

// ポーランド語のモールス信号を追加
MORSE_CODE.pl = {
    ...MORSE_CODE.en,
    'Ą': '・－・－',
    'Ć': '－・－・・',
    'Ę': '・・－・・',
    'Ł': '・－・・－',
    'Ń': '－－・－－',
    'Ó': '－－－・',
    'Ś': '・・・－・・・',
    'Ź': '－－・・－・',
    'Ż': '－－・・－－'
};

// トルコ語のモールス信号を追加 (逆引き時の曖昧さ回避のため、Aと符号が重なるİを先に定義)
MORSE_CODE.tr = {
    'İ': '・－', // 'A'と同じ符号
    ...MORSE_CODE.en,
    'Ç': '－・－・・',
    'Ğ': '－－・－・',
    'Ö': '－－－・',
    'Ş': '・－··－・',
    'Ü': '・・－－',
};

// ロシア語（キリル文字）のモールス信号を追加
MORSE_CODE.ru = {
    'А': '・－', 'Б': '－・・・', 'В': '・－－', 'Г': '－－・', 'Д': '－・・',
    'Е': '・', 'Ё': '・', // ЁはЕとして送信されることが多い
    'Ж': '・・・－', 'З': '－－・・', 'И': '・・', 'Й': '・－－－', 'К': '－・－',
    'Л': '・－・・', 'М': '－－', 'Н': '－・', 'О': '－－－', 'П': '・－－・',
    'Р': '・－・', 'С': '・・・', 'Т': '－', 'У': '・・－', 'Ф': '··－・',
    'Х': '・・・・', 'Ц': '－・－・', 'Ч': '－－－・', 'Ш': '－－－－',
    'Щ': '－－・－', 'Ъ': '－－・－－・', 'Ы': '－・－－', 'Ь': '－··－',
    'Э': '··－··', 'Ю': '··－－', 'Я': '·－·－',
    '1': '・－－－－', '2': '・・－－－', '3': '・・・－－', '4': '・・・・－', '5': '・・・・・',
    '6': '－・・・・', '7': '－－・・・', '8': '－－－・・', '9': '－－－－・', '0': '－－－－－'
};

// ドイツ語のモールス信号を追加
MORSE_CODE.de = {
    ...MORSE_CODE.en,
    'Ä': '・－・－',
    'Ö': '－－－・',
    'Ü': '・・－－',
    'ß': '・・・－－・・・'
};

// フランス語のモールス信号を追加
MORSE_CODE.fr = {
    ...MORSE_CODE.en,
    'À': '・－－・－',
    'Ç': '－・－・・',
    'É': '・・－・・',
    'È': '・－・・－',
    // 一般的なアクセント付き文字は、基本の文字の符号にマッピング
    'Â': MORSE_CODE.en['A'],
    'Ê': MORSE_CODE.en['E'],
    'Î': MORSE_CODE.en['I'],
    'Ô': MORSE_CODE.en['O'],
    'Û': MORSE_CODE.en['U'],
    'Ë': MORSE_CODE.en['E'],
    'Ï': MORSE_CODE.en['I'],
    'Ü': MORSE_CODE.en['U'],
    'Ù': MORSE_CODE.en['U']
};

// 逆引きマップを生成（モールス -> テキスト）
const MORSE_CODE_REVERSE = {};
for (const lang in MORSE_CODE) {
    MORSE_CODE_REVERSE[lang] = Object.fromEntries(
        Object.entries(MORSE_CODE[lang]).map(([key, value]) => [value, key])
    );
}

/**
 * テキストをモールス信号に変換する
 * @param {string} text - 変換するテキスト
 * @param {string} lang - 言語コード
 * @returns {string} 変換後のモールス信号
 */
function textToMorse(text, lang = 'ja') {
    const codeMap = MORSE_CODE[lang];
    if (!codeMap) return '';

    let processedText = text;

    // 和文の場合の特殊処理
    if (lang === 'ja') {
        // 1. ひらがなをカタカナに変換
        processedText = processedText.replace(/[\u3041-\u3096]/g, function(match) {
            return String.fromCharCode(match.charCodeAt(0) + 0x60);
        });

        // 2. 濁音・半濁音を「清音 + ゛/゜」の形に分解する
        const DAKUTEN_MAP = {
            'ガ': 'カ゛', 'ギ': 'キ゛', 'グ': 'ク゛', 'ゲ': 'ケ゛', 'ゴ': 'コ゛',
            'ザ': 'サ゛', 'ジ': 'シ゛', 'ズ': 'ス゛', 'ゼ': 'セ゛', 'ゾ': 'ソ゛',
            'ダ': 'タ゛', 'ヂ': 'チ゛', 'ヅ': 'ツ゛', 'デ': 'テ゛', 'ド': 'ト゛',
            'バ': 'ハ゛', 'ビ': 'ヒ゛', 'ブ': 'フ゛', 'ベ': 'ヘ゛', 'ボ': 'ホ゛',
            'パ': 'ハ゜', 'ピ': 'ヒ゜', 'プ': 'フ゜', 'ペ': 'ヘ゜', 'ポ': 'ホ゜',
            'ヴ': 'ウ゛'
        };
        
        let decomposedText = '';
        for (const char of processedText) {
            decomposedText += DAKUTEN_MAP[char] || char;
        }
        processedText = decomposedText;

        // 3. 各文字をモールス信号に変換し、対応する符号がない文字は無視する
        return processedText.split('')
            .map(char => codeMap[char])
            .filter(code => code) // undefined や '' を除去
            .join(' / ');
    } else {
        // ラテン文字ベースおよびキリル文字ベースの言語の場合
        const morseResult = [];
        for (const char of text) {
            let lookupChar = char.toUpperCase();

            // 言語ごとの特殊な文字処理
            if (lang === 'tr') {
                if (char === 'i') lookupChar = 'İ';
                if (char === 'ı') lookupChar = 'I';
            } else if (lang === 'de' && char === 'ß') {
                lookupChar = 'ß';
            }

            morseResult.push(codeMap[lookupChar]);
        }
        return morseResult.filter(Boolean).join(' / ');
    }
}

/**
 * モールス信号をテキストに変換する
 * @param {string} morse - 変換するモールス信号
 * @param {string} lang - 言語コード
 * @returns {string} 変換後のテキスト
 */
function morseToText(morse, lang = 'ja') {
    const reverseMap = MORSE_CODE_REVERSE[lang];
    if (!reverseMap) return '';

    let text = morse.split(' / ').map(code => reverseMap[code] || '?').join('');

    // 和文の場合、濁点・半濁点を結合する
    if (lang === 'ja') {
        text = text.replace(/カ゛/g, 'ガ').replace(/キ゛/g, 'ギ').replace(/ク゛/g, 'グ').replace(/ケ゛/g, 'ゲ').replace(/コ゛/g, 'ゴ');
        text = text.replace(/サ゛/g, 'ザ').replace(/シ゛/g, 'ジ').replace(/ス゛/g, 'ズ').replace(/セ゛/g, 'ゼ').replace(/ソ゛/g, 'ゾ');
        text = text.replace(/タ゛/g, 'ダ').replace(/チ゛/g, 'ヂ').replace(/ツ゛/g, 'ヅ').replace(/テ゛/g, 'デ').replace(/ト゛/g, 'ド');
        text = text.replace(/ハ゛/g, 'バ').replace(/ヒ゛/g, 'ビ').replace(/フ゛/g, 'ブ').replace(/ヘ゛/g, 'ベ').replace(/ホ゛/g, 'ボ');
        text = text.replace(/ハ゜/g, 'パ').replace(/ヒ゜/g, 'ピ').replace(/フ゜/g, 'プ').replace(/ヘ゜/g, 'ペ').replace(/ホ゜/g, 'ポ');
        text = text.replace(/ウ゛/g, 'ヴ');
    }

    return text;
}

/*
 * 注意点:
 * 中国語のモールス信号は、通常「電報コード(Chinese Telegraph Code)」という4桁の数字に漢字をマッピングし、その数字をモールス信号で送信します。[1, 2, 5]
 * このため、実装には漢字と4桁数字の巨大な対応表が別途必要になります。
 * 韓国語のモールス信号も、ラテン文字にハングルをマッピングするSKATSなどを利用することがあり、単純な対応表とは異なる場合があります。[3]
 */
